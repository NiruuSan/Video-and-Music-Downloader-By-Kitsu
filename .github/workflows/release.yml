# Build Windows and macOS releases when you publish a Release on GitHub.
# You don't need a Mac: the macOS build runs on GitHub's servers.
#
# How to use:
# 1. Push this workflow to your repo.
# 2. On GitHub: Releases → Create a new release → choose a tag (e.g. v1.0.0), publish.
# 3. This workflow runs and attaches "YouTube-Downloader-win64.zip" and
#    "YouTube-Downloader-macos.zip" to that release.

name: Release

on:
  release:
    types: [published]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable
        run: python -m PyInstaller --noconfirm downloader.spec

      - name: Create release folder
        run: |
          New-Item -ItemType Directory -Force -Path "release\YouTube Downloader"
          Copy-Item "dist\YouTube Downloader.exe" -Destination "release\YouTube Downloader\"

      - name: Download FFmpeg (Windows)
        run: |
          $url = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip"
          Invoke-WebRequest -Uri $url -OutFile "release\ffmpeg.zip" -UseBasicParsing
          Expand-Archive -Path "release\ffmpeg.zip" -DestinationPath "release" -Force
          New-Item -ItemType Directory -Force -Path "release\YouTube Downloader\ffmpeg"
          $dir = Get-ChildItem "release\ffmpeg-*" -Directory | Select-Object -First 1
          Copy-Item "$($dir.FullName)\bin\ffmpeg.exe" -Destination "release\YouTube Downloader\ffmpeg\"
          Copy-Item "$($dir.FullName)\bin\ffprobe.exe" -Destination "release\YouTube Downloader\ffmpeg\"

      - name: Zip release
        run: |
          Compress-Archive -Path "release\YouTube Downloader" -DestinationPath "YouTube-Downloader-win64.zip"
        shell: pwsh

      - name: Upload to release
        run: gh release upload "${{ github.event.release.tag_name }}" YouTube-Downloader-win64.zip --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable
        run: python3 -m PyInstaller --noconfirm downloader.spec

      - name: Create release folder
        run: |
          mkdir -p "release/YouTube Downloader"
          cp "dist/YouTube Downloader" "release/YouTube Downloader/"
          chmod +x "release/YouTube Downloader/YouTube Downloader"

      - name: Download FFmpeg (macOS)
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "arm64" ]; then
            URL="https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-macosarm64-gpl.zip"
            DIR="ffmpeg-master-latest-macosarm64-gpl"
          else
            URL="https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-macos64-gpl.zip"
            DIR="ffmpeg-master-latest-macos64-gpl"
          fi
          mkdir -p "release/YouTube Downloader/ffmpeg"
          if curl -fLsS -H "Accept: application/octet-stream" -o release/ffmpeg.zip "$URL" && [ "$(head -c 2 release/ffmpeg.zip)" = "PK" ]; then
            unzip -q -o release/ffmpeg.zip -d release
            if [ -d "release/$DIR/bin" ]; then
              cp "release/$DIR/bin/ffmpeg" "release/YouTube Downloader/ffmpeg/"
              cp "release/$DIR/bin/ffprobe" "release/YouTube Downloader/ffmpeg/"
              chmod +x "release/YouTube Downloader/ffmpeg/ffmpeg" "release/YouTube Downloader/ffmpeg/ffprobe"
            fi
          fi
          if [ ! -x "release/YouTube Downloader/ffmpeg/ffmpeg" ]; then
            echo "FFmpeg could not be bundled. Users should run: brew install ffmpeg" > "release/YouTube Downloader/INSTALL_FFMPEG.txt"
          fi

      - name: Zip release
        run: |
          cd "release/YouTube Downloader"
          zip -r ../../YouTube-Downloader-macos.zip .
          cd ../..

      - name: Upload to release
        run: gh release upload "${{ github.event.release.tag_name }}" YouTube-Downloader-macos.zip --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
